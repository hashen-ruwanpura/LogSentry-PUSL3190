<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.title }} | Log Detection Platform</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
            --header-height: 60px;
            --bg-light: #f5f7fa;
            --bg-sidebar: #f8f9fa;
            --bg-header: #fff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
        }
        
        .dashboard-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header styles */
        .main-header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
        }
        
        .logo-section h1 {
            font-size: 1.25rem;
            margin: 0 0 0 1rem;
            font-weight: 500;
        }
        
        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .username {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .logout-btn {
            color: var(--danger-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Main content container */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar.hidden {
            display: none !important;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .sidebar-nav li a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .sidebar-nav li a i {
            margin-right: 1rem;
            min-width: 20px;
            text-align: center;
        }
        
        .sidebar-nav li a:hover {
            background-color: rgba(0, 0, 0, 0.03);
            color: var(--primary-color);
        }
        
        .sidebar-nav li.active a {
            background-color: rgba(63, 81, 181, 0.1);
            color: var(--primary-color);
            font-weight: 500;
            border-left: 4px solid var(--primary-color);
        }
        
        .sidebar.collapsed .sidebar-nav li a span {
            display: none;
        }
        
        /* Content area styles */
        .content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }
        
        .content.expanded {
            margin-left: calc(var(--sidebar-collapsed-width) - var(--sidebar-width));
        }

        .content.full-width {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .page-header h2 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0;
        }
        
        .actions {
            display: flex;
            gap: 0.75rem;
        }
        
        /* Card and metrics styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border: none;
        }
        
        .card-header {
            background-color: transparent;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Report content styling */
        .report-metadata {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        
        .report-metadata-item {
            background-color: var(--bg-light);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .report-content {
            line-height: 1.7;
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .report-content h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        
        .report-content h3 {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .report-content h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .report-section {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }
        
        .report-section-alt {
            background-color: rgba(63, 81, 181, 0.05);
        }
        
        /* Highlight important sections */
        .report-content strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Add a key findings box */
        .key-findings {
            background-color: rgba(33, 150, 243, 0.1);
            border-left: 4px solid var(--info-color);
            padding: 1rem;
            margin: 1.5rem 0;
        }

        /* Rating stars */
        .star-rating {
            color: #ffc107;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .star-rating-input {
            color: #ccc;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .star-rating-input i {
            margin-right: 0.25rem;
        }
        
        .star-rating-input i.fas {
            color: #ffc107;
        }
        
        /* Related items styling */
        .related-item {
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Home nav item at bottom */
        .home-nav-item {
            margin-top: auto;
            border-top: 1px solid var(--border-color);
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-nav ul {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                z-index: 99;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .content {
                max-width: 100%;
                margin-left: 0 !important;
            }
            
            .report-metadata {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* Print styles */
        @media print {
            .sidebar, .main-header, .no-print {
                display: none !important;
            }
            
            .content {
                margin-left: 0 !important;
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
        }
    </style>
    <!-- Add this in the head section, after other script tags -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="main-header">
            <div class="logo-section">
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Log Detection Platform</h1>
            </div>
            <div class="header-actions">
                <span class="username">{{ request.user.username }}</span>
                <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul>
                        <li><a href="{% url 'dashboard' %}"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                        <li><a href="{% url 'events' %}"><i class="fas fa-calendar-alt"></i> Events</a></li>
                        <li><a href="{% url 'apache_logs' %}"><i class="fas fa-server"></i> Apache Logs</a></li>
                        <li><a href="{% url 'mysql_logs' %}"><i class="fas fa-database"></i> MySQL Logs</a></li>
                        <li><a href="{% url 'mitre_details' %}"><i class="fas fa-shield-alt"></i> MITRE ATT&CK</a></li>
                        <li><a href="{% url 'reports' %}"><i class="fas fa-file-alt"></i> Reports</a></li>
                        <li><a href="{% url 'explore_agent' %}"><i class="fas fa-robot"></i> AI Assistant</a></li>
                        <li class="active"><a href="{% url 'ai_analytics:reports_dashboard' %}"><i class="fas fa-brain"></i> <span>AI Reports</span></a></li>
                        <li><a href="{% url 'settings' %}"><i class="fas fa-cog"></i> Settings</a></li>
                        <li class="home-nav-item"><a href="/"><i class="fas fa-home"></i> <span>Home</span></a></li>
                    </ul>
                </nav>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <div class="page-header">
                    <h2>AI Report Details</h2>
                    <div class="actions">
                        <button class="btn btn-outline-secondary me-2" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-outline-primary" id="export-pdf-btn">
                            <i class="fas fa-download"></i> Export PDF
                        </button>
                    </div>
                </div>

                <!-- Report Details Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>{{ report.title }}</h3>
                        <span class="badge bg-primary">{{ report.get_report_type_display }}</span>
                    </div>
                    <div class="card-body">
                        <div class="report-metadata">
                            <div class="report-metadata-item">
                                <i class="fas fa-calendar"></i> Generated: {{ report.generated_at|date:"F j, Y, g:i a" }}
                            </div>
                            <div class="report-metadata-item">
                                <i class="fas fa-clock"></i> Analysis Period: {{ report.time_period_start|date:"M d, Y" }} - {{ report.time_period_end|date:"M d, Y" }}
                            </div>
                            {% if report.source_filter and report.source_filter != 'all' %}
                            <div class="report-metadata-item">
                                <i class="fas fa-filter"></i> Source: {{ report.get_source_filter_display }}
                            </div>
                            {% endif %}
                            {% if report.severity_filter and report.severity_filter != 'all' %}
                            <div class="report-metadata-item">
                                <i class="fas fa-exclamation-triangle"></i> Severity: {{ report.get_severity_filter_display }}
                            </div>
                            {% endif %}
                            <div class="report-metadata-item">
                                <i class="fas fa-microchip"></i> Tokens used: {{ report.tokens_used }}
                            </div>
                        </div>
                        
                        <div class="report-content" id="formatted-report-content">
                            <div class="placeholder-loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Formatting...</span>
                                </div>
                                <p class="text-center">Formatting report content...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Threats -->
                {% if related_threats %}
                <div class="card">
                    <div class="card-header">
                        <h4>Related Threats</h4>
                        <span class="badge bg-secondary">{{ related_threats.count }}</span>
                    </div>
                    <div class="card-body">
                        {% for threat in related_threats %}
                        <div class="related-item threat-item {{ threat.severity }}">
                            <div class="d-flex justify-content-between">
                                <strong>{{ threat.description|truncatechars:100 }}</strong>
                                <span class="badge bg-{% if threat.severity == 'critical' or threat.severity == 'high' %}danger{% elif threat.severity == 'medium' %}warning{% else %}info{% endif %}">
                                    {{ threat.severity|title }}
                                </span>
                            </div>
                            <div class="mt-2">
                                {% if threat.source_ip %}
                                <small class="me-3"><i class="fas fa-network-wired"></i> {{ threat.source_ip }}</small>
                                {% endif %}
                                {% if threat.mitre_tactic %}
                                <small class="me-3"><i class="fas fa-sitemap"></i> {{ threat.mitre_tactic }}</small>
                                {% endif %}
                                <small><i class="fas fa-clock"></i> {{ threat.created_at|date:"M d, Y H:i" }}</small>
                                <a href="{% url 'alert_detail' threat.id %}" class="btn btn-sm btn-outline-secondary float-end">
                                    <i class="fas fa-external-link-alt"></i> View Details
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Related Incidents -->
                {% if related_incidents %}
                <div class="card">
                    <div class="card-header">
                        <h4>Related Incidents</h4>
                        <span class="badge bg-secondary">{{ related_incidents.count }}</span>
                    </div>
                    <div class="card-body">
                        {% for incident in related_incidents %}
                        <div class="related-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ incident.name }}</strong>
                                <span class="badge bg-{% if incident.severity == 'critical' or incident.severity == 'high' %}danger{% elif incident.severity == 'medium' %}warning{% else %}info{% endif %}">
                                    {{ incident.severity|title }}
                                </span>
                            </div>
                            <div class="mt-1">{{ incident.description|truncatechars:150 }}</div>
                            <div class="mt-2">
                                <small class="me-3"><i class="fas fa-clock"></i> {{ incident.start_time|date:"M d, Y" }} - {{ incident.end_time|date:"M d, Y"|default:"Ongoing" }}</small>
                                <small class="me-3"><i class="fas fa-tag"></i> {{ incident.status|title }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Feedback Section -->
                <div class="card">
                    <div class="card-header">
                        <h4>Report Feedback</h4>
                    </div>
                    <div class="card-body">
                        {% if user_feedback %}
                        <!-- Display existing feedback -->
                        <div class="alert alert-info">
                            <p><strong>Your feedback:</strong></p>
                            <div class="star-rating">
                                {% for i in "12345" %}
                                    {% if i|add:"0" <= user_feedback.rating %}
                                    <i class="fas fa-star"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if user_feedback.comments %}
                            <p><strong>Comments:</strong> {{ user_feedback.comments }}</p>
                            {% endif %}
                            <p class="mb-0 text-muted"><small>Submitted on {{ user_feedback.submitted_at|date:"F j, Y, g:i a" }}</small></p>
                        </div>
                        <button class="btn btn-outline-primary" id="edit-feedback-btn">
                            <i class="fas fa-edit"></i> Edit Feedback
                        </button>
                        {% else %}
                        <!-- Feedback form -->
                        <form id="feedback-form">
                            <div class="mb-3">
                                <label>How would you rate this report?</label>
                                <div class="star-rating-input">
                                    <i class="far fa-star" data-rating="1"></i>
                                    <i class="far fa-star" data-rating="2"></i>
                                    <i class="far fa-star" data-rating="3"></i>
                                    <i class="far fa-star" data-rating="4"></i>
                                    <i class="far fa-star" data-rating="5"></i>
                                </div>
                                <input type="hidden" id="rating-input" name="rating" value="">
                            </div>
                            <div class="mb-3">
                                <label for="comments" class="form-label">Comments (optional)</label>
                                <textarea class="form-control" id="comments" name="comments" rows="3" placeholder="Please provide any additional feedback..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Feedback</button>
                        </form>
                        <div id="feedback-success" class="alert alert-success mt-3" style="display:none;">
                            Feedback submitted successfully! Thank you for your input.
                        </div>
                        <div id="feedback-error" class="alert alert-danger mt-3" style="display:none;">
                            Error submitting feedback. Please try again.
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Recommendations Card - Added to match dashboard style -->
                {% if report.report_type == 'security_summary' or report.report_type == 'incident_analysis' %}
                <div class="card">
                    <div class="card-header">
                        <h4>Security Recommendations</h4>
                    </div>
                    <div class="card-body">
                        <div id="recommendations-content"></div>
                    </div>
                </div>
                {% endif %}
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Define reportId from the current report
            const reportId = {{ report.id }};
            
            // Sidebar toggle - with full hide functionality
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        // Mobile view - toggle open class
                        sidebar.classList.toggle('open');
                    } else {
                        // Desktop view - fully hide instead of collapse
                        sidebar.classList.toggle('hidden');
                        content.classList.toggle('full-width');
                    }
                });
            }
            
            // Star rating functionality
            const stars = document.querySelectorAll('.star-rating-input i');
            const ratingInput = document.getElementById('rating-input');
            
            if (stars && ratingInput) {
                stars.forEach(star => {
                    star.addEventListener('mouseover', function() {
                        const rating = this.dataset.rating;
                        highlightStars(rating);
                    });
                    
                    star.addEventListener('mouseout', function() {
                        const currentRating = ratingInput.value || 0;
                        highlightStars(currentRating);
                    });
                    
                    star.addEventListener('click', function() {
                        const rating = this.dataset.rating;
                        ratingInput.value = rating;
                        highlightStars(rating);
                    });
                });
            }
            
            function highlightStars(rating) {
                stars.forEach(star => {
                    if (star.dataset.rating <= rating) {
                        star.classList.remove('far');
                        star.classList.add('fas');
                    } else {
                        star.classList.remove('fas');
                        star.classList.add('far');
                    }
                });
            }
            
            // Feedback form submission
            const feedbackForm = document.getElementById('feedback-form');
            if (feedbackForm) {
                feedbackForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const rating = document.getElementById('rating-input').value;
                    const comments = document.getElementById('comments').value;
                    
                    // Validate
                    if (!rating) {
                        // Enhanced visual alert
                        Swal.fire({
                            title: 'Rating Required',
                            text: 'Please select a rating before submitting feedback',
                            icon: 'warning',
                            confirmButtonColor: '#3f51b5'
                        });
                        return;
                    }
                    
                    // Show loading indicator
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
                    
                    // Send feedback to server
                    fetch(`/ai/reports/${reportId}/feedback/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            rating: rating,
                            comments: comments
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Server error');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Better success feedback
                            Swal.fire({
                                title: 'Feedback Submitted',
                                text: 'Thank you for your feedback!', 
                                icon: 'success',
                                confirmButtonColor: '#3f51b5',
                                timer: 2000,
                                timerProgressBar: true
                            }).then(() => {
                                location.reload(); // Reload to show updated feedback
                            });
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        
                        // Enhanced error feedback
                        Swal.fire({
                            title: 'Submission Error',
                            text: error.message || 'There was a problem submitting your feedback. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#3f51b5'
                        });
                        
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    });
                });
            }
            
            // Edit feedback functionality
            const editFeedbackBtn = document.getElementById('edit-feedback-btn');
            if (editFeedbackBtn) {
                editFeedbackBtn.addEventListener('click', function() {
                    // Get the existing feedback container
                    const feedbackDisplay = document.querySelector('.alert.alert-info');
                    
                    // Create a form for editing (fixed Django template syntax)
                    const formContainer = document.createElement('div');
                    
                    // Store the current feedback values
                    const currentRating = {{ user_feedback.rating|default:0 }};
                    const currentComments = "{{ user_feedback.comments|default:''|escapejs }}";
                    
                    // Generate HTML with proper escaping for Django templates
                    formContainer.innerHTML = `
                        <form id="feedback-form" class="mt-3">
                            <div class="mb-3">
                                <label>Update your rating:</label>
                                <div class="star-rating-input">
                                    <i class="far fa-star" data-rating="1"></i>
                                    <i class="far fa-star" data-rating="2"></i>
                                    <i class="far fa-star" data-rating="3"></i>
                                    <i class="far fa-star" data-rating="4"></i>
                                    <i class="far fa-star" data-rating="5"></i>
                                </div>
                                <input type="hidden" id="rating-input" name="rating" value="${currentRating}">
                            </div>
                            <div class="mb-3">
                                <label for="comments" class="form-label">Comments (optional)</label>
                                <textarea class="form-control" id="comments" name="comments" rows="3" 
                                    placeholder="Please provide any additional feedback...">${currentComments}</textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Update Feedback</button>
                                <button type="button" id="cancel-edit" class="btn btn-outline-secondary">Cancel</button>
                            </div>
                        </form>
                    `;
                    
                    // Hide the current display and append the form
                    feedbackDisplay.style.display = 'none';
                    editFeedbackBtn.style.display = 'none';
                    feedbackDisplay.parentNode.insertBefore(formContainer, feedbackDisplay.nextSibling);
                    
                    // Initialize the star rating
                    const stars = document.querySelectorAll('.star-rating-input i');
                    const ratingInput = document.getElementById('rating-input');
                    
                    // Set initial rating from current feedback
                    ratingInput.value = currentRating;
                    highlightStars(currentRating);
                    
                    // Add event listeners to stars
                    stars.forEach(star => {
                        star.addEventListener('mouseover', function() {
                            highlightStars(this.dataset.rating);
                        });
                        
                        star.addEventListener('mouseout', function() {
                            highlightStars(ratingInput.value || 0);
                        });
                        
                        star.addEventListener('click', function() {
                            ratingInput.value = this.dataset.rating;
                            highlightStars(this.dataset.rating);
                        });
                    });
                    
                    // Handle cancel button
                    const cancelBtn = document.getElementById('cancel-edit');
                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', function() {
                            formContainer.remove();
                            feedbackDisplay.style.display = '';
                            editFeedbackBtn.style.display = '';
                        });
                    }
                    
                    // Handle form submission
                    const feedbackForm = document.getElementById('feedback-form');
                    if (feedbackForm) {
                        feedbackForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            
                            const rating = document.getElementById('rating-input').value;
                            const comments = document.getElementById('comments').value;
                            
                            // Validate
                            if (!rating) {
                                Swal.fire({
                                    title: 'Rating Required',
                                    text: 'Please select a rating before submitting feedback',
                                    icon: 'warning',
                                    confirmButtonColor: '#3f51b5'
                                });
                                return;
                            }
                            
                            // Show loading indicator
                            const submitBtn = this.querySelector('button[type="submit"]');
                            const originalText = submitBtn.innerHTML;
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
                            
                            // Send feedback to server
                            fetch(`/ai/reports/${reportId}/feedback/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    rating: rating,
                                    comments: comments,
                                    updating: true
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        throw new Error(data.error || 'Server error');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    // Better success feedback
                                    Swal.fire({
                                        title: 'Feedback Updated',
                                        text: 'Your feedback has been successfully updated!', 
                                        icon: 'success',
                                        confirmButtonColor: '#3f51b5',
                                        timer: 2000,
                                        timerProgressBar: true
                                    }).then(() => {
                                        location.reload(); // Reload to show updated feedback
                                    });
                                } else {
                                    throw new Error(data.error || 'Unknown error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                
                                // Enhanced error feedback
                                Swal.fire({
                                    title: 'Update Error',
                                    text: error.message || 'There was a problem updating your feedback. Please try again.',
                                    icon: 'error',
                                    confirmButtonColor: '#3f51b5'
                                });
                                
                                // Reset button
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            });
                        });
                    }
                });
            }
            
            // Export PDF functionality
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function() {
                    // Show loading indicator
                    Swal.fire({
                        title: 'Generating PDF',
                        text: 'Please wait while we prepare your download...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Prepare a simpler version of the content for better PDF compatibility
                    const reportTitle = document.querySelector('.card-header h3').textContent;
                    
                    // Create a clean container for PDF content with minimal styling
                    const pdfContent = document.createElement('div');
                    
                    // Add title and metadata
                    const titleSection = document.createElement('div');
                    titleSection.innerHTML = `
                        <h1 style="color: #3f51b5; font-size: 24px; margin-bottom: 20px; text-align: center;">${reportTitle}</h1>
                        <div style="margin-bottom: 20px; font-size: 13px; color: #666;">
                            <p>Generated: {{ report.generated_at|date:"F j, Y, g:i a" }}</p>
                            <p>Analysis Period: {{ report.time_period_start|date:"M d, Y" }} - {{ report.time_period_end|date:"M d, Y" }}</p>
                            <p>Report Type: {{ report.get_report_type_display }}</p>
                        </div>
                        <hr style="border-top: 2px solid #3f51b5; margin: 20px 0;">
                    `;
                    pdfContent.appendChild(titleSection);
                    
                    // Get the actual content - already formatted nicely
                    const contentDiv = document.getElementById('formatted-report-content');
                    const contentClone = contentDiv.cloneNode(true);
                    
                    // Remove any interactive elements or large images that might cause problems
                    const placeholders = contentClone.querySelectorAll('.placeholder-loading');
                    placeholders.forEach(el => el.remove());
                    
                    // Add content to our PDF container
                    pdfContent.appendChild(contentClone);
                    
                    // Add recommendations if available
                    const recommendationsDiv = document.getElementById('recommendations-content');
                    if (recommendationsDiv && recommendationsDiv.innerHTML.trim()) {
                        const recSection = document.createElement('div');
                        recSection.innerHTML = `
                            <h2 style="color: #3f51b5; margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Recommendations</h2>
                        `;
                        recSection.appendChild(recommendationsDiv.cloneNode(true));
                        pdfContent.appendChild(recSection);
                    }
                    
                    // Clean the content for PDF compatibility
                    const elementsToSimplify = pdfContent.querySelectorAll('.report-section, .report-section-alt');
                    elementsToSimplify.forEach(el => {
                        // Keep content but remove complex background styling
                        el.style.backgroundColor = 'transparent';
                        el.style.borderRadius = '0';
                    });
                    
                    // Set PDF options - try more compatible settings
                    const opt = {
                        margin: [20, 20],
                        filename: `${reportTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_report.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { 
                            scale: 1.5, 
                            useCORS: true,
                            logging: false,
                            removeContainer: true,
                            letterRendering: true
                        },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    
                    // Add a short timeout to ensure the Sweet Alert is shown before PDF processing starts
                    setTimeout(() => {
                        // Generate PDF with better error handling
                        html2pdf().from(pdfContent).set(opt)
                            .save()
                            .then(() => {
                                console.log('PDF generated successfully');
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Your PDF has been downloaded.',
                                    icon: 'success',
                                    confirmButtonColor: '#3f51b5'
                                });
                            })
                            .catch(err => {
                                console.error('PDF generation error:', err);
                                Swal.fire({
                                    title: 'Export Failed',
                                    text: 'Unable to generate PDF. Try using the Print option instead.',
                                    icon: 'error',
                                    confirmButtonColor: '#3f51b5'
                                });
                            });
                    }, 500);
                });
            }
            
            // Format the report content for better readability
            function formatReportContent() {
                const rawContent = `{{ report.content|escapejs }}`;
                const contentDiv = document.getElementById('formatted-report-content');
                const recommendationsDiv = document.getElementById('recommendations-content');
                
                if (!contentDiv) return;
                
                // Function to convert markdown-like syntax to HTML
                function markdownToHtml(content) {
                    // Replace markdown headers
                    content = content.replace(/^# (.*$)/gm, '<h2 class="mt-4 mb-3">$1</h2>');
                    content = content.replace(/^## (.*$)/gm, '<h3 class="mt-3 mb-2">$1</h3>');
                    content = content.replace(/^### (.*$)/gm, '<h4 class="mt-3 mb-2">$1</h4>');
                    
                    // Replace numbered lists with proper HTML lists
                    let processedContent = content;
                    const listRegex = /^\d+\.\s+(.*$)/gm;
                    const listMatches = content.match(listRegex);
                    
                    if (listMatches) {
                        let listHtml = '<ol class="mb-3">';
                        listMatches.forEach(match => {
                            const listItemText = match.replace(/^\d+\.\s+/, '');
                            listHtml += `<li>${listItemText}</li>`;
                            processedContent = processedContent.replace(match, '');
                        });
                        listHtml += '</ol>';
                        processedContent = processedContent.replace(/\n\n/g, '</p><p class="mb-3">');
                        processedContent = processedContent.replace(/\n/g, ' ');
                        content = processedContent + listHtml;
                    }
                    
                    // Replace bullet points with proper HTML lists
                    content = content.replace(/^[\*\-]\s+(.*$)/gm, '<li>$1</li>');
                    content = content.replace(/(<li>.*<\/li>\n)+/g, '<ul class="mb-3">$&</ul>');
                    
                    // Replace bold text
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    // Handle report sections - look for patterns like "Section Name:" or "SECTION NAME:"
                    content = content.replace(/^([A-Z][A-Za-z\s]+):/gm, '<h3 class="section-title">$1:</h3>');
                    
                    // Find recommendations section
                    const recommendationsRegex = /Recommendations?:?([\s\S]*?)(?=\n\n[A-Z]|\n\n$|$)/i;
                    const recommendationsMatch = content.match(recommendationsRegex);
                    
                    if (recommendationsMatch && recommendationsDiv) {
                        // Extract recommendations and format them
                        let recommendationsContent = recommendationsMatch[1].trim();
                        
                        // Convert plain text recommendations to list if not already
                        if (!recommendationsContent.includes('<li>')) {
                            const recItems = recommendationsContent.split(/\n+/);
                            recommendationsContent = '<ul class="mb-3">';
                            recItems.forEach(item => {
                                if (item.trim()) {
                                    // Remove any numbers at start
                                    const cleanItem = item.trim().replace(/^\d+[\.\)]\s*/, '');
                                    recommendationsContent += `<li>${cleanItem}</li>`;
                                }
                            });
                            recommendationsContent += '</ul>';
                        }
                        
                        recommendationsDiv.innerHTML = recommendationsContent;
                        
                        // Remove recommendations from main content
                        content = content.replace(recommendationsRegex, '');
                    }
                    
                    // Handle paragraphs with proper spacing
                    content = content.replace(/\n\n/g, '</p><p class="mb-3">');
                    
                    // Wrap the entire content in paragraph tags if it's not already
                    if (!content.startsWith('<')) {
                        content = '<p class="mb-3">' + content + '</p>';
                    }
                    
                    return content;
                }
                
                // Format the content
                contentDiv.innerHTML = markdownToHtml(rawContent);
                
                // Add styling for different sections
                const sections = contentDiv.querySelectorAll('h2, h3.section-title');
                sections.forEach((section, index) => {
                    // Add a subtle background to alternate sections
                    const sectionContent = document.createElement('div');
                    sectionContent.className = 'report-section ' + 
                        ((index % 2 === 0) ? 'report-section-alt' : '');
                    
                    // Move all elements between this section and the next into the section container
                    let nextElement = section.nextElementSibling;
                    while (nextElement && 
                          !['H2', 'H3'].includes(nextElement.tagName) && 
                          !nextElement.classList.contains('section-title')) {
                        const temp = nextElement.nextElementSibling;
                        sectionContent.appendChild(nextElement);
                        nextElement = temp;
                    }
                    
                    // Insert section after the heading
                    section.parentNode.insertBefore(sectionContent, section.nextSibling);
                    sectionContent.insertBefore(section, sectionContent.firstChild);
                });
            }
            
            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Call the formatter
            formatReportContent();
        });
    </script>
</body>
</html>
`