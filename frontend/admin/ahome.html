<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LogSentry</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3f51b5;
            --primary-dark: #303f9f;
            --primary-light: #c5cae9;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --white: #ffffff;
            --card-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            color: #333;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--dark-bg) 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
            z-index: 100;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            padding: 25px 20px;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .logo i {
            margin-right: 10px;
            background: var(--primary-light);
            color: var(--primary-dark);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 25px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }
        
        .card-stat {
            position: relative;
            z-index: 1;
        }
        
        .card-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
            z-index: -1;
        }
        
        .card-stat.critical::before {
            background-color: var(--danger-color);
        }
        
        .card-stat.monitoring::before {
            background-color: var(--success-color);
        }
        
        .card-stat.users::before {
            background-color: var(--warning-color);
        }
        
        .alert-count {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }
        
        .trend-indicator {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .trend-indicator i {
            margin-right: 5px;
        }
        
        .trend-up {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }
        
        .trend-down {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }
        
        .top-bar {
            background-color: white;
            padding: 18px 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: var(--success-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .status-danger {
            background-color: var(--danger-color);
        }
        
        .severity-high {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .severity-medium {
            color: var(--warning-color);
        }
        
        .severity-low {
            color: var(--info-color);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .dropdown-item:hover {
            background-color: rgba(63, 81, 181, 0.05);
        }
        
        .dropdown-item i {
            font-size: 1rem;
            width: 24px;
            color: var(--primary-color);
        }
        
        .action-btn {
            border-radius: 8px;
            padding: 12px 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            border: none;
        }
        
        .action-btn i {
            margin-right: 8px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .action-btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .action-btn-outline:hover {
            background-color: rgba(63, 81, 181, 0.05);
        }
        
        .status-card {
            border-radius: 12px;
            margin-bottom: 15px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .status-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .status-icon {
            min-width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
            color: white;
        }
        
        .status-icon.online {
            background-color: var(--success-color);
        }
        
        .status-icon.warning {
            background-color: var(--warning-color);
        }
        
        .status-icon.offline {
            background-color: var(--danger-color);
        }
        
        .status-details {
            flex: 1;
        }
        
        .status-server {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .status-metrics {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .status-metrics span:not(:last-child) {
            margin-right: 15px;
        }
        
        .progress {
            height: 8px;
            margin-top: 8px;
            border-radius: 4px;
            background-color: #eaecef;
        }
        
        .progress-bar {
            border-radius: 4px;
        }
        
        .system-metrics {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .metric-item {
            padding: 16px;
            border-radius: 10px;
            background-color: white;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        
        .metric-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .metric-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .metric-value {
            font-weight: 700;
            font-size: 14px;
        }
        
        .toast-container {
            z-index: 9999;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .mobile-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-shield-alt"></i> LogSentry
        </div>
        <div class="mt-4">
            <a href="/admin-home/" class="nav-link active">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="/admin-panel/logs/" class="nav-link">
                <i class="fas fa-clipboard-list"></i> Log Analysis
            </a>
            <a href="/admin-panel/alerts/" class="nav-link">
                <i class="fas fa-exclamation-triangle"></i> Alerts
            </a>
            <a href="/admin-panel/adminreports/" class="nav-link">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
            <a href="/admin-panel/users/" class="nav-link">
                <i class="fas fa-users"></i> User Management
            </a>
            <a href="/admin-panel/user-support/" class="nav-link">
                <i class="fas fa-headset"></i> User Support
            </a>
            <a href="/admin-panel/settings/" class="nav-link">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="/logout/" class="nav-link mt-5">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <h4 class="mb-0 d-flex align-items-center">
                <i class="fas fa-shield-alt text-primary me-2"></i> Admin Dashboard
            </h4>
            <div class="d-flex align-items-center">
                <button id="refreshDashboardBtn" class="action-btn action-btn-outline me-3">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <span class="me-3 d-none d-md-inline">Welcome, Admin</span>
                <span class="badge bg-primary d-flex align-items-center">
                    <i class="fas fa-clock me-1"></i> 
                    <span id="last-refresh-time">Just now</span>
                </span>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card card-stat">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-subtitle text-muted">Total Alerts</h6>
                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle">
                                <i class="fas fa-bell text-primary"></i>
                            </div>
                        </div>
                        <h2 class="alert-count">127</h2>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up"></i> 12% from last week
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card card-stat critical">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-subtitle text-muted">Critical Threats</h6>
                            <div class="bg-danger bg-opacity-10 p-2 rounded-circle">
                                <i class="fas fa-radiation-alt text-danger"></i>
                            </div>
                        </div>
                        <h2 class="alert-count">14</h2>
                        <div class="trend-indicator trend-down">
                            <i class="fas fa-arrow-down"></i> 5% from last week
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card card-stat monitoring">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-subtitle text-muted">Servers Monitored</h6>
                            <div class="bg-success bg-opacity-10 p-2 rounded-circle">
                                <i class="fas fa-server text-success"></i>
                            </div>
                        </div>
                        <h2 class="alert-count">8</h2>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-check"></i> All online
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card card-stat users">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-subtitle text-muted">Active Users</h6>
                            <div class="bg-warning bg-opacity-10 p-2 rounded-circle">
                                <i class="fas fa-users text-warning"></i>
                            </div>
                        </div>
                        <h2 class="alert-count">42</h2>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up"></i> 8% from last month
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8 mb-4 mb-md-0">
                <div class="chart-container h-100">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-line text-primary me-2"></i> Threat Activity (Last 7 Days)
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-period="week">Week</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-period="month">Month</button>
                        </div>
                    </div>
                    <canvas id="threatActivityChart" height="250"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container h-100">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie text-primary me-2"></i> Alert Distribution
                        </div>
                    </div>
                    <canvas id="alertDistributionChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Server Status and System Health Row -->
        <div class="row">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="chart-container h-100">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-server text-primary me-2"></i> Server Status
                        </div>
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-cog"></i> Manage
                        </button>
                    </div>
                    
                    <div class="server-status-container">
                        <div class="status-card">
                            <div class="status-icon online">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-server">Web Server (Apache)</div>
                                <div class="status-metrics">
                                    <span><i class="fas fa-check-circle text-success me-1"></i> Online</span>
                                    <span><i class="fas fa-tachometer-alt me-1"></i> Load: 42%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon online">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-server">Database Server (MySQL)</div>
                                <div class="status-metrics">
                                    <span><i class="fas fa-check-circle text-success me-1"></i> Online</span>
                                    <span><i class="fas fa-tachometer-alt me-1"></i> Load: 38%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 38%" aria-valuenow="38" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon warning">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-server">Application Server</div>
                                <div class="status-metrics">
                                    <span><i class="fas fa-exclamation-triangle text-warning me-1"></i> High Load</span>
                                    <span><i class="fas fa-tachometer-alt me-1"></i> Load: 78%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon online">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-server">Backup Server</div>
                                <div class="status-metrics">
                                    <span><i class="fas fa-check-circle text-success me-1"></i> Online</span>
                                    <span><i class="fas fa-tachometer-alt me-1"></i> Load: 12%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 12%" aria-valuenow="12" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon online">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-server">Log Analysis Service</div>
                                <div class="status-metrics">
                                    <span><i class="fas fa-check-circle text-success me-1"></i> Active</span>
                                    <span><i class="fas fa-clock me-1"></i> Last run: 5m ago</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-heartbeat text-primary me-2"></i> System Health
                                </div>
                            </div>
                            <div class="system-metrics">
                                <div class="metric-item">
                                    <div class="metric-header">
                                        <div class="metric-name">CPU Usage</div>
                                        <div class="metric-value">32%</div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 32%" aria-valuenow="32" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-header">
                                        <div class="metric-name">Memory Usage</div>
                                        <div class="metric-value">45%</div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-header">
                                        <div class="metric-name">Disk Space</div>
                                        <div class="metric-value">63%</div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 63%" aria-valuenow="63" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-bolt text-primary me-2"></i> Quick Actions
                                </div>
                            </div>
                            <div class="d-grid gap-3">
                                <button id="runLogAnalysisBtn" class="action-btn action-btn-primary">
                                    <i class="fas fa-sync-alt"></i> Run Log Analysis
                                </button>
                                <div class="dropdown w-100">
                                    <button id="exportReportBtn" class="action-btn action-btn-outline dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-file-export"></i> Export Report
                                    </button>
                                    <ul class="dropdown-menu w-100 shadow-sm border-0" aria-labelledby="exportReportBtn">
                                        <li><h6 class="dropdown-header">Select Format</h6></li>
                                        <li><a class="dropdown-item" href="#" data-format="pdf"><i class="fas fa-file-pdf text-danger"></i> PDF Document</a></li>
                                        <li><a class="dropdown-item" href="#" data-format="xlsx"><i class="fas fa-file-excel text-success"></i> Excel Spreadsheet</a></li>
                                        <li><a class="dropdown-item" href="#" data-format="csv"><i class="fas fa-file-csv text-primary"></i> CSV File</a></li>
                                    </ul>
                                </div>
                                <a href="/admin-panel/settings/" id="configureAlertsBtn" class="action-btn action-btn-outline">
                                    <i class="fas fa-bell"></i> Configure Alerts
                                </a>
                                <a href="/admin-panel/logs/" class="action-btn action-btn-outline">
                                    <i class="fas fa-search"></i> View Detailed Logs
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize charts when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch dashboard data from backend
            fetchDashboardData();
            
            // Update last refresh time
            updateRefreshTime();
            setInterval(updateRefreshTime, 60000); // Update every minute
            
            // Add period selector functionality for charts
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Fetch data for selected period
                    fetchDashboardData(this.dataset.period);
                });
            });
        });

        function updateRefreshTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-refresh-time').textContent = timeString;
        }

        // Replace the existing fetchDashboardData function with this improved version

        function fetchDashboardData(period = 'week') {
            // Show loading spinner
            document.getElementById('refreshDashboardBtn').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Loading...';
            
            console.log('Fetching dashboard data for period:', period);
            
            // Add cache-busting parameter to prevent cached responses
            const timestamp = new Date().getTime();
            return fetch(`/api/admin/dashboard-data/?timeframe=${period}&_=${timestamp}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache'
                },
                credentials: 'same-origin' // Include cookies for authentication
            })
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    if (response.status === 500) {
                        return response.json().then(errorData => {
                            throw new Error(`Server error: ${errorData.error || 'Unknown server error'}`);
                        });
                    }
                    if (response.status === 404) {
                        throw new Error('API endpoint not found: Check URL configuration');
                    }
                    if (response.status === 403) {
                        throw new Error('Access denied: You might not have permission to access this resource');
                    }
                    if (response.status === 401) {
                        // Redirect to login page if not authenticated
                        window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
                        throw new Error('Authentication required');
                    }
                    throw new Error(`HTTP error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dashboard data received:', data);
                
                // Check data structure and log warnings for missing data
                if (!data.counts) console.warn('Missing counts data');
                if (!data.threat_activity) console.warn('Missing threat_activity data');
                if (!data.alert_distribution) console.warn('Missing alert_distribution data');
                if (!data.server_status) console.warn('Missing server_status data');
                
                // Update dashboard with fetched data
                updateCounts(data.counts || {});
                updateThreatActivityChart(data.threat_activity || {});
                updateAlertDistributionChart(data.alert_distribution || {});
                updateServerStatus(data.server_status || []);
                
                // Reset the refresh button
                document.getElementById('refreshDashboardBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                
                return data; // Return data for any further processing
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
                
                // Show error message to the user
                showToast('Error', `Failed to load dashboard data: ${error.message}`, 'error');
                
                // Reset the refresh button
                document.getElementById('refreshDashboardBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                
                throw error; // Rethrow for further handling if needed
            });
        }

        function updateCounts(counts) {
            // Update count cards with real data
            document.querySelector('.col-md-3:nth-child(1) .alert-count').textContent = counts.total_alerts;
            document.querySelector('.col-md-3:nth-child(2) .alert-count').textContent = counts.critical_alerts;
            document.querySelector('.col-md-3:nth-child(3) .alert-count').textContent = counts.servers_monitored;
            document.querySelector('.col-md-3:nth-child(4) .alert-count').textContent = counts.active_users;
        }

        function updateThreatActivityChart(threatActivity) {
            const threatCtx = document.getElementById('threatActivityChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.threatChart) {
                window.threatChart.destroy();
            }
            
            // Create new chart with real data
            window.threatChart = new Chart(threatCtx, {
                type: 'line',
                data: {
                    labels: threatActivity.labels,
                    datasets: [
                        {
                            label: 'High Severity',
                            data: threatActivity.high_severity,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Medium Severity',
                            data: threatActivity.medium_severity,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Low Severity',
                            data: threatActivity.low_severity,
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            padding: 10,
                            cornerRadius: 4
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateAlertDistributionChart(alertDistribution) {
            const alertCtx = document.getElementById('alertDistributionChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.alertChart) {
                window.alertChart.destroy();
            }
            
            // Ensure alertDistribution is an object
            if (!alertDistribution || typeof alertDistribution !== 'object') {
                console.error('Invalid alert distribution data:', alertDistribution);
                alertDistribution = {"No Data Available": 1};
            }
            
            // Convert alert distribution data to arrays for chart
            const labels = Object.keys(alertDistribution);
            const data = Object.values(alertDistribution);
            
            console.log('Alert Distribution Chart Data:', { labels, data });
            
            // Use custom colors
            const colors = [
                '#3f51b5',
                '#dc3545',
                '#ffc107',
                '#28a745',
                '#6f42c1'
            ];
            
            // Create new chart with real data
            window.alertChart = new Chart(alertCtx, {
                type: 'doughnut',
                data: {
                    labels: labels.length > 0 ? labels : ['No Data Available'],
                    datasets: [{
                        data: data.length > 0 ? data : [1],
                        backgroundColor: colors.slice(0, labels.length || 1),
                        borderWidth: 0,
                        hoverOffset: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            padding: 10,
                            cornerRadius: 4,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%',
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });
        }

        // Replace the existing updateServerStatus function with this fully dynamic implementation

        function updateServerStatus(servers) {
            const container = document.querySelector('.server-status-container');
            if (!container) return;
            
            // If no server data, keep existing content
            if (!servers || !servers.length) return;
            
            // Clear existing content and create new cards
            container.innerHTML = '';
            
            servers.forEach(server => {
                // Determine status class
                let statusClass = 'online';
                let statusIcon = 'check-circle';
                let statusText = 'Online';
                let progressBarClass = 'bg-success';
                
                if (server.status === 'high_load' || server.status === 'warning') {
                    statusClass = 'warning';
                    statusIcon = 'exclamation-triangle';
                    statusText = 'High Load';
                    progressBarClass = 'bg-warning';
                } else if (server.status === 'offline' || server.status === 'error') {
                    statusClass = 'offline';
                    statusIcon = 'times-circle';
                    statusText = 'Offline';
                    progressBarClass = 'bg-danger';
                } else if (server.status === 'active') {
                    statusIcon = 'check-circle';
                    statusText = 'Active';
                    progressBarClass = 'bg-info';
                }
                
                // Determine server icon
                let serverIcon = 'server';
                if (server.name.toLowerCase().includes('web') || server.name.toLowerCase().includes('apache')) {
                    serverIcon = 'globe';
                } else if (server.name.toLowerCase().includes('database') || server.name.toLowerCase().includes('mysql')) {
                    serverIcon = 'database';
                } else if (server.name.toLowerCase().includes('backup')) {
                    serverIcon = 'hdd';
                } else if (server.name.toLowerCase().includes('log') || server.name.toLowerCase().includes('analysis')) {
                    serverIcon = 'search';
                } else if (server.name.toLowerCase().includes('application')) {
                    serverIcon = 'cogs';
                }
                
                // Create status card
                const card = document.createElement('div');
                card.className = 'status-card';
                
                // For load-based servers
                if (server.load !== undefined) {
                    card.innerHTML = `
                        <div class="status-icon ${statusClass}">
                            <i class="fas fa-${serverIcon}"></i>
                        </div>
                        <div class="status-details">
                            <div class="status-server">${server.name}</div>
                            <div class="status-metrics">
                                <span><i class="fas fa-${statusIcon} text-${statusClass === 'online' ? 'success' : statusClass === 'warning' ? 'warning' : 'danger'} me-1"></i> ${statusText}</span>
                                <span><i class="fas fa-tachometer-alt me-1"></i> Load: ${server.load}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${progressBarClass}" role="progressbar" style="width: ${server.load}%" 
                                    aria-valuenow="${server.load}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    `;
                } 
                // For services with last run time
                else if (server.last_run) {
                    card.innerHTML = `
                        <div class="status-icon ${statusClass}">
                            <i class="fas fa-${serverIcon}"></i>
                        </div>
                        <div class="status-details">
                            <div class="status-server">${server.name}</div>
                            <div class="status-metrics">
                                <span><i class="fas fa-${statusIcon} text-${statusClass === 'online' ? 'success' : statusClass === 'warning' ? 'warning' : 'danger'} me-1"></i> ${statusText}</span>
                                <span><i class="fas fa-clock me-1"></i> Last run: ${server.last_run}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${progressBarClass}" role="progressbar" style="width: 100%" 
                                    aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Fallback to hardcoded data if API fails
        function initializeChartsWithHardcodedData() {
            // First check if charts already exist and destroy them
            if (window.threatChart) {
                window.threatChart.destroy();
            }
            if (window.alertChart) {
                window.alertChart.destroy();
            }

            // Initialize threat activity chart with sample data
            const threatCtx = document.getElementById('threatActivityChart').getContext('2d');
            window.threatChart = new Chart(threatCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'High Severity',
                            data: [4, 3, 2, 5, 3, 1, 4],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Medium Severity',
                            data: [7, 6, 8, 9, 6, 5, 7],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Low Severity',
                            data: [12, 10, 13, 8, 11, 9, 14],
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Initialize alert distribution chart with sample data
            const alertCtx = document.getElementById('alertDistributionChart').getContext('2d');
            window.alertChart = new Chart(alertCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Apache Server', 'MySQL Server', 'Application Server', 'Other'],
                    datasets: [{
                        data: [45, 30, 15, 10],
                        backgroundColor: [
                            '#3f51b5',
                            '#dc3545',
                            '#ffc107',
                            '#28a745'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        document.getElementById('refreshDashboardBtn').addEventListener('click', function() {
            // Show spinning icon while refreshing
            this.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
            this.disabled = true;
            
            fetchDashboardData().finally(() => {
                // Reset button after refresh
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                this.disabled = false;
                updateRefreshTime();
            });
        });

        // Quick Actions Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Run Log Analysis Button
            document.getElementById('runLogAnalysisBtn').addEventListener('click', runLogAnalysis);
            
            // Export Report Button - attach listeners to dropdown items instead of the button
            document.querySelectorAll('#exportReportBtn + .dropdown-menu .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const format = this.getAttribute('data-format');
                    exportDashboardReport(format);
                });
            });
        });

        // Function to run log analysis
        function runLogAnalysis() {
            const button = document.getElementById('runLogAnalysisBtn');
            
            // Disable button and show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Analysis...';
            
            // Make API call to trigger log analysis
            fetch('/api/admin/run-log-analysis/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Permission denied. You might need to refresh your session.');
                    }
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.error || 'Failed to start log analysis');
                        } catch (e) {
                            throw new Error(`Failed to start log analysis (Status: ${response.status})`);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                button.classList.remove('action-btn-primary');
                button.classList.add('btn-success');
                button.innerHTML = '<i class="fas fa-check"></i> Analysis Complete';
                
                // Show toast notification
                showToast('Log Analysis', 'Analysis completed successfully. New threats detected: ' + (data.threats_detected || 0), 'success');
                
                // Refresh dashboard data to show new results
                setTimeout(() => {
                    fetchDashboardData();
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        button.classList.remove('btn-success');
                        button.classList.add('action-btn-primary');
                        button.innerHTML = '<i class="fas fa-sync-alt"></i> Run Log Analysis';
                        button.disabled = false;
                    }, 3000);
                }, 1000);
            })
            .catch(error => {
                console.error('Error running log analysis:', error);
                
                // Show error state
                button.classList.remove('action-btn-primary');
                button.classList.add('btn-danger');
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Analysis Failed';
                
                // Show error toast
                showToast('Log Analysis', 'Failed to complete analysis: ' + error.message, 'error');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.classList.remove('btn-danger');
                    button.classList.add('action-btn-primary');
                    button.innerHTML = '<i class="fas fa-sync-alt"></i> Run Log Analysis';
                    button.disabled = false;
                }, 3000);
            });
        }

        // Replace the existing exportDashboardReport function with this enhanced version

        function exportDashboardReport(format) {
            // Get button element
            const button = document.getElementById('exportReportBtn');
            
            // Validate format
            if (!['pdf', 'xlsx', 'csv'].includes(format)) {
                showToast('Export Error', 'Invalid export format selected', 'error');
                return;
            }
            
            // Disable button and show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Report...';
            
            // Make API call to generate report
            fetch(`/api/admin/export-report/?format=${format.toLowerCase()}`, {
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to generate report (Status: ${response.status})`);
                }
                
                // Check if it's a download or just a response
                const contentType = response.headers.get('Content-Type');
                if (contentType && (contentType.includes('application/pdf') || 
                                    contentType.includes('text/csv') || 
                                    contentType.includes('application/vnd.openxmlformats'))) {
                    return response.blob().then(blob => {
                        // Create download link and trigger download
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `threat_report_${new Date().toISOString().slice(0,10)}.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        return { success: true, message: 'Report downloaded' };
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                button.classList.remove('action-btn-outline');
                button.classList.add('btn-success');
                button.innerHTML = '<i class="fas fa-check"></i> Report Generated';
                
                // Show success toast
                showToast('Report Export', 'Report generated and downloaded successfully', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.classList.remove('btn-success');
                    button.classList.add('action-btn-outline');
                    button.innerHTML = '<i class="fas fa-file-export"></i> Export Report';
                    button.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error exporting report:', error);
                
                // Show error state
                button.classList.remove('action-btn-outline');
                button.classList.add('btn-danger');
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Export Failed';
                
                // Show error toast
                showToast('Report Export', 'Failed to generate report: ' + error.message, 'error');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.classList.remove('btn-danger');
                    button.classList.add('action-btn-outline');
                    button.innerHTML = '<i class="fas fa-file-export"></i> Export Report';
                    button.disabled = false;
                }, 3000);
            });
        }

        // Replace the existing getCsrfToken function with this more robust version

        function getCsrfToken() {
            // Try to get token from cookie
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            
            // If not found in cookie, try to get from meta tag
            if (!cookieValue) {
                const meta = document.querySelector('meta[name="csrf-token"]');
                if (meta) {
                    cookieValue = meta.getAttribute('content');
                }
            }
            
            return cookieValue;
        }

        // Helper function to show toast notifications
        function showToast(title, message, type) {
            // Check if we have Bootstrap 5 toast
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                // Create toast container if it doesn't exist
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    document.body.appendChild(toastContainer);
                }
                
                // Create toast element
                const toastElement = document.createElement('div');
                toastElement.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0 shadow`;
                toastElement.setAttribute('role', 'alert');
                toastElement.setAttribute('aria-live', 'assertive');
                toastElement.setAttribute('aria-atomic', 'true');
                
                // Create toast content
                toastElement.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong>: ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                // Add to container
                toastContainer.appendChild(toastElement);
                
                // Initialize and show toast
                const toast = new bootstrap.Toast(toastElement, {
                    delay: 5000
                });
                toast.show();
                
                // Remove after it's hidden
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            } else {
                // Fallback to alert if Bootstrap Toast is not available
                alert(`${title}: ${message}`);
            }
        }
    </script>
</body>
</html>