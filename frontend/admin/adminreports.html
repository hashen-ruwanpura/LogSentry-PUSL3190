<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Dashboard | Threat Detection Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        :root {
            --primary-color: #3a6ea5;
            --secondary-color: #004e8a;
            --accent-color: #ff6b6b;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .sidebar {
            background-color: var(--dark-bg);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
            z-index: 100;
        }
        
        .logo {
            padding: 20px 15px;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 4px 0;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .top-bar {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .report-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            height: 100%;
        }
        
        .report-card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-weight: 500;
        }
        
        .report-card-body {
            padding: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card .stat-icon {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2.5rem;
            opacity: 0.2;
        }
        
        .stat-card .stat-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-change {
            font-size: 0.8rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .severity-high {
            color: var(--danger-color);
        }
        
        .severity-medium {
            color: var(--warning-color);
        }
        
        .severity-low {
            color: var(--primary-color);
        }
        
        .small-stat {
            font-size: 0.85rem;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .report-filters {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-shield-alt"></i> ThreatGuard
        </div>
        <div class="mt-4">
            <a href="/admin-home/" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="/admin-panel/logs/" class="nav-link">
                <i class="fas fa-clipboard-list"></i> Log Analysis
            </a>
            <a href="/admin-panel/alerts/" class="nav-link">
                <i class="fas fa-exclamation-triangle"></i> Alerts
            </a>
            <a href="/admin-panel/reports/" class="nav-link active">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
            <a href="/admin-panel/users/" class="nav-link">
                <i class="fas fa-users"></i> User Management
            </a>
            <a href="/admin-panel/settings/" class="nav-link">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="/logout/" class="nav-link mt-5">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Reports Dashboard</h4>
            <div>
                <button id="refreshReports" class="btn btn-sm btn-outline-secondary me-2">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="dropdown d-inline-block">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                        <li><a class="dropdown-item export-btn" data-format="pdf" href="#"><i class="far fa-file-pdf me-2"></i> Export as PDF</a></li>
                        <li><a class="dropdown-item export-btn" data-format="csv" href="#"><i class="far fa-file-excel me-2"></i> Export as CSV</a></li>
                        <li><a class="dropdown-item export-btn" data-format="json" href="#"><i class="far fa-file-code me-2"></i> Export as JSON</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Report Filters -->
        <div class="report-filters">
            <form id="reportFilters" class="row g-3">
                <div class="col-md-4">
                    <label for="dateRange" class="form-label">Date Range</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="dateRange">
                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="logType" class="form-label">Log Type</label>
                    <select class="form-select" id="logType">
                        <option value="all" selected>All Types</option>
                        <option value="apache">Apache</option>
                        <option value="mysql">MySQL</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="severityFilter" class="form-label">Severity</label>
                    <select class="form-select" id="severityFilter">
                        <option value="all" selected>All</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="groupBy" class="form-label">Group By</label>
                    <select class="form-select" id="groupBy">
                        <option value="day" selected>Daily</option>
                        <option value="week">Weekly</option>
                        <option value="month">Monthly</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>
            </form>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-danger">
                        <i class="fas fa-shield-virus"></i>
                    </div>
                    <div class="stat-title">Total Threats</div>
                    <div class="stat-value" id="totalThreats">--</div>
                    <div class="stat-change text-success" id="threatChange">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-warning">
                        <i class="fas fa-user-ninja"></i>
                    </div>
                    <div class="stat-title">Intrusion Attempts</div>
                    <div class="stat-value" id="intrusionAttempts">--</div>
                    <div class="stat-change text-danger" id="intrusionChange">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-primary">
                        <i class="fas fa-bug"></i>
                    </div>
                    <div class="stat-title">System Errors</div>
                    <div class="stat-value" id="systemErrors">--</div>
                    <div class="stat-change text-success" id="errorChange">--</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-success">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-title">Blocked Attacks</div>
                    <div class="stat-value" id="blockedAttacks">--</div>
                    <div class="stat-change text-success" id="blockedChange">--</div>
                </div>
            </div>
        </div>

        <!-- Main Reports Section -->
        <div class="row">
            <!-- Threat Trend Chart -->
            <div class="col-md-8 mb-4">
                <div class="report-card">
                    <div class="report-card-header d-flex justify-content-between align-items-center">
                        <span>Threat Trend</span>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-period="day">Daily</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-period="week">Weekly</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-period="month">Monthly</button>
                        </div>
                    </div>
                    <div class="report-card-body">
                        <div class="chart-container">
                            <canvas id="threatTrendChart"></canvas>
                            <div class="loading-overlay">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Severity Distribution -->
            <div class="col-md-4 mb-4">
                <div class="report-card">
                    <div class="report-card-header">
                        Severity Distribution
                    </div>
                    <div class="report-card-body">
                        <div class="chart-container">
                            <canvas id="severityDistChart"></canvas>
                            <div class="loading-overlay">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 small-stat">
                            <div class="row text-center">
                                <div class="col">
                                    <div class="severity-high"><i class="fas fa-exclamation-circle"></i> High</div>
                                    <strong id="highSeverityCount">--</strong>
                                </div>
                                <div class="col">
                                    <div class="severity-medium"><i class="fas fa-exclamation-triangle"></i> Medium</div>
                                    <strong id="mediumSeverityCount">--</strong>
                                </div>
                                <div class="col">
                                    <div class="severity-low"><i class="fas fa-info-circle"></i> Low</div>
                                    <strong id="lowSeverityCount">--</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Attack Types -->
            <div class="col-md-12 mb-4">
                <div class="report-card">
                    <div class="report-card-header">
                        Top Attack Types
                    </div>
                    <div class="report-card-body">
                        <div class="chart-container">
                            <canvas id="attackTypeChart"></canvas>
                            <div class="loading-overlay">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Threats Table -->
            <div class="col-12 mb-4">
                <div class="report-card">
                    <div class="report-card-header d-flex justify-content-between align-items-center">
                        <span>Recent Threats</span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tableExportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="tableExportDropdown">
                                <li><a class="dropdown-item export-btn" data-format="pdf" href="#"><i class="far fa-file-pdf me-2"></i> PDF</a></li>
                                <li><a class="dropdown-item export-btn" data-format="csv" href="#"><i class="far fa-file-excel me-2"></i> CSV</a></li>
                                <li><a class="dropdown-item export-btn" data-format="json" href="#"><i class="far fa-file-code me-2"></i> JSON</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="report-card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Source IP</th>
                                        <th>Log Type</th>
                                        <th>Threat Type</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recentThreatsTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="threatDetailModal" tabindex="-1" aria-labelledby="threatDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="threatDetailModalLabel">Threat Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="threatDetailContent">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Timestamp</th>
                                    <td id="modal-timestamp"></td>
                                </tr>
                                <tr>
                                    <th>Source IP</th>
                                    <td id="modal-source"></td>
                                </tr>
                                <tr>
                                    <th>Country</th>
                                    <td id="modal-country"></td>
                                </tr>
                                <tr>
                                    <th>Threat Type</th>
                                    <td id="modal-threat-type"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Additional Details</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Log Type</th>
                                    <td id="modal-log-type"></td>
                                </tr>
                                <tr>
                                    <th>Severity</th>
                                    <td id="modal-severity"></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="modal-status"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Raw Log</h6>
                        <pre id="modal-raw-log" class="p-3 bg-light" style="max-height: 200px; overflow-y: auto;"></pre>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Notes</h6>
                        <textarea id="modal-notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="resolveBtn">Mark as Resolved</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Document loaded, initializing reports dashboard...");
            
            // Initialize date range picker with default dates
            $('#dateRange').daterangepicker({
                ranges: {
                   'Today': [moment(), moment()],
                   'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                   'This Month': [moment().startOf('month'), moment().endOf('month')],
                   'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                startDate: moment().subtract(30, 'days'),
                endDate: moment(),
                maxDate: moment(),
                locale: {
                    format: 'YYYY-MM-DD'
                }
            });
            
            // Wait for daterangepicker to fully initialize before restoring filters
            setTimeout(() => {
                // Restore filters from session storage if available
                const savedFilters = sessionStorage.getItem('reportFilters');
                if (savedFilters) {
                    try {
                        const filters = JSON.parse(savedFilters);
                        console.log("Restoring saved filters:", filters);
                        
                        // Use moment objects consistently for date handling
                        if (filters.startDate && filters.endDate) {
                            try {
                                // Always create proper moment objects
                                const startDate = moment(filters.startDate, 'YYYY-MM-DD');
                                const endDate = moment(filters.endDate, 'YYYY-MM-DD');
                                
                                if (startDate.isValid() && endDate.isValid()) {
                                    const today = moment();
                                    // Use the moment objects directly
                                    $('#dateRange').data('daterangepicker').setStartDate(
                                        startDate.isAfter(today) ? today : startDate
                                    );
                                    $('#dateRange').data('daterangepicker').setEndDate(
                                        endDate.isAfter(today) ? today : endDate
                                    );
                                } else {
                                    console.error("Invalid dates in saved filters");
                                    resetToDefaultDates();
                                }
                            } catch (dateError) {
                                console.error("Error setting date range:", dateError);
                                resetToDefaultDates();
                            }
                        }
                        
                        // Set select inputs
                        if (filters.logType && document.getElementById('logType')) {
                            document.getElementById('logType').value = filters.logType;
                        }
                        if (filters.severity && document.getElementById('severityFilter')) {
                            document.getElementById('severityFilter').value = filters.severity;
                        }
                        if (filters.groupBy && document.getElementById('groupBy')) {
                            document.getElementById('groupBy').value = filters.groupBy;
                        }
                    } catch (e) {
                        console.error("Error restoring filters:", e);
                        resetToDefaultDates();
                    }
                }
                
                // Load initial data
                loadDashboardData();
            }, 500); // Increased timeout to ensure initialization
            
            // Helper function to reset dates
            function resetToDefaultDates() {
                $('#dateRange').data('daterangepicker').setStartDate(moment().subtract(30, 'days'));
                $('#dateRange').data('daterangepicker').setEndDate(moment());
            }
            
            // Set up event listeners
            document.getElementById('reportFilters').addEventListener('submit', function(e) {
                e.preventDefault();
                loadDashboardData();
            });
            
            document.getElementById('refreshReports').addEventListener('click', function() {
                loadDashboardData();
            });
            
            // Add event listeners for export buttons
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const format = this.getAttribute('data-format');
                    console.log("Exporting in format:", format);
                    exportReports(format);
                });
            });
            
            // Set up period buttons for threat trend chart
            document.querySelectorAll('.btn-group[role="group"] button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    this.parentElement.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const period = this.getAttribute('data-period');
                    updateThreatChart(period);
                });
            });
            
            // Initialize resolve button handler in modal
            document.getElementById('resolveBtn').addEventListener('click', function() {
                const threatId = this.getAttribute('data-threat-id');
                if (threatId) {
                    resolveThreat(threatId);
                }
            });
        });
        
        // Load all dashboard data
        function loadDashboardData() {
            console.log("Loading dashboard data...");
            showLoaders();
            
            // Get filter values
            const filters = getFilters();
            console.log("Using filters:", filters);
            
            // Use the actual dashboard endpoint with filters
            fetch('/api/admin/reports/simple-dashboard', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(filters)
            })
            .then(response => {
                console.log("Response status:", response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error("Error response:", text);
                        throw new Error(`Server responded with ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);
                if (data.error) {
                    console.error("API returned error:", data.error);
                    throw new Error(data.error);
                }
                updateDashboard(data);
                hideLoaders();
                
                // Store the current filters in sessionStorage
                sessionStorage.setItem('reportFilters', JSON.stringify(filters));
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
                hideLoaders();
                document.querySelectorAll('.loading-overlay').forEach(loader => {
                    loader.style.display = 'none';
                });
                alert('Error loading dashboard data: ' + error.message);
            });
        }
        
        // Get filter values
        function getFilters() {
            const dateRange = $('#dateRange').data('daterangepicker');
            
            // Default dates if daterangepicker is not initialized yet
            let startDate = moment().subtract(30, 'days').format('YYYY-MM-DD');
            let endDate = moment().format('YYYY-MM-DD');
            
            // If daterangepicker is initialized, use its values with consistent format
            if (dateRange && dateRange.startDate && dateRange.endDate) {
                if (dateRange.startDate.isValid() && dateRange.endDate.isValid()) {
                    startDate = dateRange.startDate.format('YYYY-MM-DD');
                    endDate = dateRange.endDate.format('YYYY-MM-DD');
                }
            }
            
            const logType = document.getElementById('logType')?.value || 'all';
            const severity = document.getElementById('severityFilter')?.value || 'all';
            const groupBy = document.getElementById('groupBy')?.value || 'day';
            
            console.log(`Filters: ${startDate} to ${endDate}, type: ${logType}, severity: ${severity}, groupBy: ${groupBy}`);
            
            return {
                startDate: startDate,
                endDate: endDate,
                logType: logType,
                severity: severity,
                groupBy: groupBy
            };
        }
        
        // Update dashboard with data
        function updateDashboard(data) {
            // Update stats
            document.getElementById('totalThreats').textContent = data.stats.totalThreats;
            document.getElementById('intrusionAttempts').textContent = data.stats.intrusionAttempts;
            document.getElementById('systemErrors').textContent = data.stats.systemErrors;
            document.getElementById('blockedAttacks').textContent = data.stats.blockedAttacks;
            
            document.getElementById('threatChange').textContent = `${data.stats.threatChange}% vs. previous period`;
            document.getElementById('threatChange').className = data.stats.threatChange < 0 ? 'stat-change text-success' : 'stat-change text-danger';
            
            document.getElementById('intrusionChange').textContent = `${data.stats.intrusionChange}% vs. previous period`;
            document.getElementById('intrusionChange').className = data.stats.intrusionChange < 0 ? 'stat-change text-success' : 'stat-change text-danger';
            
            document.getElementById('errorChange').textContent = `${data.stats.errorChange}% vs. previous period`;
            document.getElementById('errorChange').className = data.stats.errorChange < 0 ? 'stat-change text-success' : 'stat-change text-danger';
            
            document.getElementById('blockedChange').textContent = `${data.stats.blockedChange}% vs. previous period`;
            document.getElementById('blockedChange').className = data.stats.blockedChange < 0 ? 'stat-change text-danger' : 'stat-change text-success';
            
            // Update severity counts
            document.getElementById('highSeverityCount').textContent = data.severity.high;
            document.getElementById('mediumSeverityCount').textContent = data.severity.medium;
            document.getElementById('lowSeverityCount').textContent = data.severity.low;
            
            // Update charts
            updateThreatTrendChart(data.threatTrend);
            updateSeverityDistChart(data.severity);
            updateAttackTypeChart(data.attackTypes);
            
            // Update recent threats table
            updateRecentThreatsTable(data.recentThreats);
        }
        
        // Fix the updateThreatTrendChart function
        function updateThreatTrendChart(trendData) {
            const ctx = document.getElementById('threatTrendChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.threatTrendChart instanceof Chart) {
                window.threatTrendChart.destroy();
            }
            
            window.threatTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [
                        {
                            label: 'High',
                            data: trendData.high,
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Medium',
                            data: trendData.medium,
                            borderColor: 'rgba(255, 193, 7, 1)',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Low',
                            data: trendData.low,
                            borderColor: 'rgba(13, 110, 253, 1)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Update severity distribution chart
        function updateSeverityDistChart(severityData) {
            const ctx = document.getElementById('severityDistChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.severityDistChart instanceof Chart) {
                window.severityDistChart.destroy();
            }
            
            window.severityDistChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [severityData.high, severityData.medium, severityData.low],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(13, 110, 253, 0.8)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(13, 110, 253, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update attack type chart
        function updateAttackTypeChart(attackTypes) {
            const ctx = document.getElementById('attackTypeChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.attackTypeChart instanceof Chart) {
                window.attackTypeChart.destroy();
            }
            
            // Sort attack types by count in descending order
            const sortedTypes = Object.entries(attackTypes).sort((a, b) => b[1] - a[1]);
            const labels = sortedTypes.map(item => item[0]);
            const data = sortedTypes.map(item => item[1]);
            
            window.attackTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: data,
                        backgroundColor: 'rgba(58, 110, 165, 0.8)',
                        borderColor: 'rgba(58, 110, 165, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Update recent threats table
        function updateRecentThreatsTable(threats) {
            const tableBody = document.getElementById('recentThreatsTable');
            tableBody.innerHTML = '';
            
            if (threats.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No threats found</td></tr>';
                return;
            }
            
            threats.forEach(threat => {
                const tr = document.createElement('tr');
                
                const formattedDate = new Date(threat.timestamp).toLocaleString();
                
                // Severity class
                let severityClass = '';
                if (threat.severity === 'High') {
                    severityClass = 'severity-high';
                } else if (threat.severity === 'Medium') {
                    severityClass = 'severity-medium';
                } else {
                    severityClass = 'severity-low';
                }
                
                // Status badge
                let statusBadge = '';
                if (threat.status === 'Resolved') {
                    statusBadge = '<span class="badge bg-success">Resolved</span>';
                } else if (threat.status === 'In Progress') {
                    statusBadge = '<span class="badge bg-warning">In Progress</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">Open</span>';
                }
                
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${threat.sourceIp}</td>
                    <td>${threat.logType}</td>
                    <td>${threat.threatType}</td>
                    <td class="${severityClass}">${threat.severity}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-details" data-id="${threat.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const threatId = this.getAttribute('data-id');
                    showThreatDetails(threatId);
                });
            });
        }
        
        // Show threat details in modal
        function showThreatDetails(threatId) {
            fetch(`/api/admin/reports/threat-details/${threatId}`, {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Populate modal with data
                document.getElementById('modal-timestamp').textContent = new Date(data.timestamp).toLocaleString();
                document.getElementById('modal-source').textContent = data.sourceIp;
                document.getElementById('modal-country').textContent = data.country;
                document.getElementById('modal-threat-type').textContent = data.threatType;
                document.getElementById('modal-log-type').textContent = data.logType;
                document.getElementById('modal-severity').textContent = data.severity;
                document.getElementById('modal-status').textContent = data.status;
                document.getElementById('modal-raw-log').textContent = data.rawLog;
                document.getElementById('modal-notes').value = data.notes || '';
                
                // Store threat ID for resolve button
                document.getElementById('resolveBtn').setAttribute('data-threat-id', threatId);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('threatDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching threat details:', error);
                alert('Failed to load threat details. Please try again.');
            });
        }
        
        // Fix the resolveThreat function syntax error
        function resolveThreat(threatId) {
            fetch(`/api/admin/reports/resolve-threat/${threatId}`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    notes: document.getElementById('modal-notes').value
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('threatDetailModal')).hide();
                
                // Reload dashboard to reflect changes
                loadDashboardData();
                
                // Show success message
                alert('Threat has been marked as resolved.');
            })
            .catch(error => {
                console.error('Error resolving threat:', error);
                alert('Failed to resolve threat. Please try again.');
            });
        }
        
        // Update threat trend chart based on period
        function updateThreatChart(period) {
            const filters = getFilters();
            filters.groupBy = period;
            
            fetch('/api/admin/reports/threat-trend', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(filters)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateThreatTrendChart(data);
            })
            .catch(error => {
                console.error('Error updating threat chart:', error);
                alert('Failed to update chart. Please try again later.');
            });
        }
        
        // Export reports
        function exportReports(format) {
            console.log("Starting export in format:", format);
            const filters = getFilters();
            
            try {
                // Create a form for the export
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/api/admin/reports/export';
                form.target = '_blank';
                
                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = getCsrfToken();
                form.appendChild(csrfInput);
                
                // Add filter inputs
                const startDateInput = document.createElement('input');
                startDateInput.type = 'hidden';
                startDateInput.name = 'startDate';
                startDateInput.value = filters.startDate;
                form.appendChild(startDateInput);
                
                const endDateInput = document.createElement('input');
                endDateInput.type = 'hidden';
                endDateInput.name = 'endDate';
                endDateInput.value = filters.endDate;
                form.appendChild(endDateInput);
                
                const logTypeInput = document.createElement('input');
                logTypeInput.type = 'hidden';
                logTypeInput.name = 'logType';
                logTypeInput.value = filters.logType;
                form.appendChild(logTypeInput);
                
                const severityInput = document.createElement('input');
                severityInput.type = 'hidden';
                severityInput.name = 'severity';
                severityInput.value = filters.severity;
                form.appendChild(severityInput);
                
                const formatInput = document.createElement('input');
                formatInput.type = 'hidden';
                formatInput.name = 'format';
                formatInput.value = format;
                form.appendChild(formatInput);
                
                console.log("Export form created with data:", {
                    startDate: filters.startDate,
                    endDate: filters.endDate,
                    logType: filters.logType,
                    severity: filters.severity,
                    format: format
                });
                
                // Submit the form
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                console.log("Export form submitted");
            } catch (error) {
                console.error("Error during export:", error);
                alert("Failed to export reports: " + error.message);
            }
        }
        
        // Show loaders
        function showLoaders() {
            document.querySelectorAll('.loading-overlay').forEach(loader => {
                loader.style.display = 'flex';
            });
            document.getElementById('recentThreatsTable').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Hide loaders
        function hideLoaders() {
            document.querySelectorAll('.loading-overlay').forEach(loader => {
                loader.style.display = 'none';
            });
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        }

        // Improved error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.message, e.filename, e.lineno);
        });
    </script>
</body>
</html>